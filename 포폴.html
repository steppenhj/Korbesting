<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>포트폴리오 다이어리- US SmallCap Insight</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts: Roboto & Open Sans -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700|Open+Sans:400,600&display=swap" rel="stylesheet">
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- chartjs-plugin-datalabels CDN (차트에 상시 라벨 표시) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <style>
    html {
      font-size: 16px;
    }
    :root {
      --primary-color: #004080;
      --secondary-color: #0059b3;
      --accent-color: #f4f7fa;
      --light-gray: #e0e0e0;
      --text-color: #333;
    }
    /* 기본 리셋 */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(135deg, var(--accent-color), #cbd7e3);
      color: var(--text-color);
      padding-bottom: 60px;
    }
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    header h1 {
      font-family: 'Roboto', sans-serif;
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    header p {
      font-size: 1rem;
    }
    nav {
      margin-top: 0.5rem;
    }
    nav ul {
      list-style: none;
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    nav ul li a {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #fff;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      border-radius: 4px;
      text-decoration: none;
      transition: background-color 0.3s, color 0.3s;
    }
    nav ul li a:hover {
      background-color: var(--primary-color);
      color: #fff;
    }
    main {
      max-width: 960px;
      margin: 1rem auto;
      padding: 0 1rem;
    }
    /* 브라우저에 영구저장 안내 문구 */
    .save-notice {
      background: #fff;
      color: #444;
      font-size: 0.9rem;
      padding: 0.6rem 1rem;
      margin-bottom: 0.5rem;
      border-left: 4px solid var(--primary-color);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      line-height: 1.4;
    }
    h2 {
      font-size: 1.8rem;
      color: var(--primary-color);
      margin-bottom: 1rem;
      text-align: center;
    }
    h3 {
      font-size: 1.2rem;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 0.3rem;
      margin-bottom: 1rem;
    }
    /* 포트폴리오 영역: 섹션들을 세로로 배치 */
    .portfolio-sections {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      justify-content: flex-start;
    }
    /* 섹션 컨테이너는 기존 스타일 그대로 */
    .section-container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      padding: 1rem;
      width: 100%;
    }
    /* 각 섹션 내부를 좌측(입력폼)과 우측(그래프)으로 나누기 위한 flex 컨테이너 */
    .portfolio-section-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
      margin-top: 1rem;
    }
    .left-content {
      flex: 1;
    }
    .right-chart {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }
    /* 자산 포트폴리오 동적 항목 */
    .asset-item {
      display: flex;
      align-items: left;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .asset-item input[type="text"],
    .asset-item input[type="text"]::placeholder,
    .asset-item input[type="number"] {
      /* 금액 입력 필드의 type을 text로 변경 */
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      font-size: 0.9rem;
      width: 100px;
    }
    .asset-item button {
      padding: 0.3rem 0.6rem;
      background: #b30000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .asset-item button:hover {
      background: #800000;
    }
    .portfolio-form {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .portfolio-form button {
      padding: 0.3rem 0.6rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    .portfolio-form button:hover {
      background: #003060;
    }
    .chart-container {
      margin: 0;
    }
    /* 기본 캔버스 높이 (동적으로 조절할 예정) */
    canvas {
      width: 100%;
      height: 300px;
    }
    .recommendation {
      background: var(--light-gray);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
      text-align: center;
      font-size: 0.8rem;
    }
    /* 주식 포트폴리오 */
    .stock-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .stock-item input[type="text"],
    .stock-item input[type="text"]::placeholder,
    .stock-item input[type="number"] {
      padding: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      font-size: 0.9rem;
      width: 120px;
    }
    .stock-item button {
      padding: 0.3rem 0.6rem;
      background: #b30000;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .stock-item button:hover {
      background: #800000;
    }
    /* 하단 정보 영역: 체크리스트, 자산 목표, 투자 일지 */
    .bottom-info {
      max-width: 960px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .investment-checklist {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .investment-checklist ul {
      list-style: none;
      padding-left: 0;
    }
    .investment-checklist li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 0.8rem 0;
    }
    .investment-checklist li:last-child {
      border-bottom: none;
    }
    .investment-checklist input[type="checkbox"] {
      width: 1.5em;
      height: 1.5em;
      transform: scale(1.2);
      margin-left: 10px;
    }
    .checklist-add {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .checklist-add input {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .checklist-add button {
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .checklist-add button:hover {
      background: #003060;
    }
    /* 자산 목표 영역 (흰색 배경 컨테이너 추가) */
    .asset-goal {
      margin-bottom: 1rem;
    }
    .asset-goal-container {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      border-radius: 8px;
    }
    /* 자산 목표 진행바 스타일 */
    #assetGoalProgress {
      margin-top: 1rem;
    }
    .progress-bar {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .progress {
      height: 20px;
      background-color: var(--primary-color);
      width: 0%;
      transition: width 0.5s;
      text-align: center;
      color: #fff;
      line-height: 20px;
      font-size: 0.9rem;
    }
    /* 투자 일지 */
    .investment-diary {
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
    }
    .investment-diary textarea {
      width: 100%;
      height: 150px;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      resize: vertical;
    }
    .investment-diary button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    .investment-diary button:hover {
      background: #003060;
    }
    .diary-entry {
      border-top: 1px solid #ddd;
      padding: 0.5rem 0;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }
    .diary-entry time {
      font-weight: bold;
      margin-right: 0.5rem;
    }
    .diary-entry .diary-text {
      flex: 1;
      margin: 0 8px;
    }
    footer {
      background-color: var(--primary-color);
      color: #fff;
      text-align: center;
      padding: 0.8rem;
      bottom: 0;
      width: 100%;
      font-size: 1rem;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.3);
    }
    @media (max-width: 1000px) {
      .section-container {
        width: 100%;
      }
      .portfolio-sections {
        flex-wrap: wrap;
      }
    }
    @media (max-width: 600px) {
      header h1 {
        font-size: 1.6rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>US SmallCap Insight</h1>
    <p>"미국 중소형주, 쉽게 찾고 투자하자!"</p>
    <nav>
      <ul>
        <li><a href="index.html">메인 페이지</a></li>
        <li><a href="포폴.html">포트폴리오</a></li>
        <li><a href="전문가분석.html">전문가 분석</a></li>
        <li><a href="유명인포폴.html">인기 포트폴리오</a></li>
      </ul>
    </nav>
  </header>
  
  <main>
    <!-- 로그인 없이 브라우저에 영구 저장 안내 -->
    <div class="save-notice">
      이 페이지는 <strong>로그인 없이도</strong> 현재 사용하는 <strong>브라우저에 영구 저장</strong>됩니다.<br>
      다시 방문하더라도 입력했던 내역이 유지됩니다.
    </div>

    <h2>포트폴리오 다이어리</h2>
    <div class="recommendation">
      <strong>Tip:</strong> 입력한 금액의 비중이 자동으로 계산됩니다.<br>
      모두 입력한 후 새로고침을 한 번 하세요.
    </div>
    <div class="portfolio-sections">
      <!-- [자산 포트폴리오] 동적 항목 영역 -->
      <section class="section-container" id="asset-portfolio">
        <h3>자산 포트폴리오</h3>
        <p style="font-size:0.9rem; line-height: 1.4;">
          다양한 자산(예: 현금, 채권, 부동산, 주식, 기타)의 투자 금액을 입력하세요.<br>
          입력한 금액을 바탕으로 자동으로 각 항목의 비율이 계산되어 차트로 표시됩니다.
        </p>
          <h3>왜 자산 포트폴리오가 중요한가?</h3>
          <p style="font-size:1rem; line-height:1.6;">
            많은 사람들이 <strong>주식 포트폴리오</strong>에만 집중하지만, 사실 <strong>자산 포트폴리오</strong>가 장기적인 재무 안정성을 결정짓는 핵심 요소입니다.
            투자에서 가장 중요한 것은 <strong>수익률뿐만 아니라 리스크 관리</strong>입니다. 
          </p>
          
          <h4 style="color:#004080; margin-top:1rem;">1. 단일 투자보다 리스크를 줄여줍니다.</h4>
          <p style="font-size:0.95rem; line-height:1.6;">
            주식만 보유하고 있다면 시장 변동성에 크게 영향을 받을 수 있습니다. 하지만 현금, 채권, 부동산, 금과 같은 
            <strong>다양한 자산을 함께 보유하면 변동성을 줄이고 안정적인 성장</strong>을 기대할 수 있습니다.
          </p>
        
          <h4 style="color:#004080; margin-top:1rem;">2. 자산 배분이 곧 수익률을 결정합니다.</h4>
          <p style="font-size:0.95rem; line-height:1.6;">
            미국 예일대의 연구에 따르면 <strong>포트폴리오의 장기 수익률은 개별 종목 선택보다 자산 배분이 더 큰 영향을 미친다</strong>는 결과가 있습니다.
            즉, 어떤 주식을 선택하느냐보다 <strong>어떤 자산을 얼마만큼 배분하느냐</strong>가 더 중요합니다.
          </p>
        
          <h4 style="color:#004080; margin-top:1rem;">3. 위기 상황에서 더 큰 차이를 만듭니다.</h4>
          <p style="font-size:0.95rem; line-height:1.6;">
            2008년 금융 위기, 2020년 코로나 팬데믹 등 <strong>시장 충격이 발생할 때마다</strong> 주식 시장은 크게 하락했습니다. 
            하지만 채권, 금, 부동산을 함께 보유한 투자자들은 이러한 위기를 훨씬 더 안정적으로 버텨냈습니다.
            결국 <strong>자산 포트폴리오를 잘 구성하면 위기에 강한 투자 전략</strong>을 만들 수 있습니다.
          </p>
        
          <h4 style="color:#004080; margin-top:1rem;">4. 자산 포트폴리오가 곧 당신의 재정 설계입니다.</h4>
          <p style="font-size:0.95rem; line-height:1.6;">
            단기적인 주식 수익률에 일희일비하지 말고, <strong>장기적인 재정 목표</strong>를 생각해야 합니다. 
            부동산을 통해 주거 안정성을 확보하고, 채권을 통해 고정적인 현금 흐름을 만들고, 주식을 통해 성장성을 추구하는 것이 
            <strong>현명한 투자자의 전략</strong>입니다.
          </p>
        
        <div class="portfolio-section-content">
          <div class="left-content">
            <!-- 동적 자산 항목들이 들어갈 영역 -->
            <div id="assetItemsContainer"></div>
            <div class="portfolio-form">
              <button id="addAssetItemBtn">자산 항목 추가</button>
            </div>
          </div>
          <div class="right-chart">
            <div class="chart-container">
              <canvas id="assetChart"></canvas>
            </div>
          </div>
        </div>
      </section>
      
      <!-- [주식 포트폴리오] 동적 항목 영역 -->
      <section class="section-container" id="stock-portfolio">
        <h3>주식 포트폴리오</h3>
        <p style="font-size:0.9rem; line-height: 1.4;">
          투자할 종목의 이름과 투자 금액을 입력하세요.<br>
          입력한 금액의 총합을 기준으로 각 종목의 비율이 자동으로 계산되어 차트로 표시됩니다.
        </p>
        <div class="portfolio-section-content">
          <div class="left-content">
            <div class="portfolio-form" style="flex-direction: column; align-items: flex-start;">
              <div id="stockList"></div>
              <button id="addStockBtn">종목 추가</button>
            </div>
          </div>
          <div class="right-chart">
            <div class="chart-container">
              <canvas id="stockChart"></canvas>
            </div>
          </div>
        </div>
      </section>
    </div>
    
    <!-- 하단 정보: 체크리스트, 자산 목표, 투자 일지 -->
    <div class="bottom-info">
    <!-- 나만의 투자 원칙 체크리스트 -->
    <div class="investment-checklist">
      <h3>나만의 투자 원칙 체크리스트</h3>
      <p style="font-size:0.9rem; line-height: 1.4; margin-top: 0.5rem;">
        새로운 종목을 구매할 때 고려해야 할 중요한 원칙을 체크하세요.
      </p>
      <ul id="checklist">
        <!-- 체크리스트 항목은 자바스크립트에서 렌더링 -->
      </ul>
      <div class="checklist-add">
        <input type="text" id="newChecklistItem" placeholder="원칙을 입력하세요">
        <button id="addChecklistItemBtn">추가</button>
      </div>
    </div>

      <!-- 나의 자산 목표 영역 (흰색 배경 컨테이너 추가) -->
      <div class="asset-goal">
        <div class="asset-goal-container">
          <h3>나의 자산 목표</h3>
          <p>목표 자산 금액을 입력하세요:</p>
          <div class="asset-goal-form">
            <!-- type 변경: number -> text -->
            <input type="text" id="assetGoalInput" placeholder="예: 10000000">
            <button id="saveAssetGoalBtn">저장</button>
          </div>
          <div id="assetGoalDisplay"></div>
          <!-- 진행바를 표시할 영역 -->
          <div id="assetGoalProgress"></div>
        </div>
      </div>
      
      <!-- 투자 일지 영역 -->
      <div class="investment-diary">
        <h3>투자 일지</h3>
        <textarea id="investmentDiary" placeholder="오늘의 투자 일지를 작성하세요..."></textarea>
        <button id="saveDiaryBtn">저장</button>
        <div id="diaryEntries"></div>
      </div>
      
      <!-- 데이터 초기화 버튼 (추가 기능) -->
      <div style="text-align:center; margin-top:1rem;">
        <button id="resetDataBtn" style="background:#800000;"><strong>데이터 초기화</strong></button>
      </div>
    </div>
  </main>
  
  <footer>
    <p>
      © 2025 US SmallCap Insight. All rights reserved.<br>
      사업체 지역: 대한민국 대구<br>
      문의: <a href="mailto:hermann8hesse@gmail.com" style="color:#fff; text-decoration:underline;">hermann8hesse@gmail.com</a><br>
      아이디어가 있으시면 언제든지 메일로 제안해 주세요!
    </p>
  </footer>
  
  <!-- JavaScript: 포트폴리오, 체크리스트, 자산 목표, 투자 일지 기능 -->
  <script>
    // chartjs-plugin-datalabels 등록
    Chart.register(ChartDataLabels);
    
    let assetChart, stockChart;
    
    // 실시간으로 1000단위 쉼표를 추가하는 함수
    function addCommaFormatting(inputElement) {
      inputElement.addEventListener('input', function() {
        // 현재 커서 위치 보존은 복잡하므로, 여기서는 단순하게 값 전체를 포맷팅하여 끝으로 커서를 이동합니다.
        let numericValue = inputElement.value.replace(/,/g, '');
        if(numericValue === '') {
          inputElement.value = '';
          return;
        }
        let num = parseFloat(numericValue);
        if(isNaN(num)) return;
        let formattedValue = num.toLocaleString('en-US');
        inputElement.value = formattedValue;
        inputElement.selectionStart = inputElement.selectionEnd = inputElement.value.length;
      });
    }
    
    /* ---------- 동적 캔버스 사이즈 조절 함수 (수정됨) ---------- */
    function adjustChartSize(canvasId, itemCount) {
      const canvas = document.getElementById(canvasId);
      // 기본 사이즈와 항목 당 추가 픽셀 (필요에 따라 조정)
      const baseSize = 300;
      const extraPerItem = 30; 
      const newSize = baseSize + itemCount * extraPerItem;
      // 캔버스의 실제 사이즈와 스타일 모두 변경
      canvas.height = newSize;
      canvas.width = newSize;
      canvas.style.height = newSize + "px";
      canvas.style.width = newSize + "px";
    }
    
    /* ---------- 자산 포트폴리오 기능 ---------- */
    function createAssetItem(asset = {name:"", amount:0}) {
      const div = document.createElement("div");
      div.classList.add("asset-item");
      
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "자산명";
      nameInput.value = asset.name || "";
      nameInput.addEventListener("input", updateAssetChart);
      
      const amountInput = document.createElement("input");
      // 금액 입력 필드: type을 text로 변경
      amountInput.type = "text";
      amountInput.placeholder = "금액";
      amountInput.value = asset.amount || 0;
      amountInput.min = 0;
      amountInput.addEventListener("input", updateAssetChart);
      addCommaFormatting(amountInput);
      
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "삭제";
      removeBtn.addEventListener("click", () => {
        div.remove();
        saveAssetPortfolio();
        updateAssetChart();
      });
      
      div.appendChild(nameInput);
      div.appendChild(amountInput);
      div.appendChild(removeBtn);
      return div;
    }
    
    function loadAssetPortfolio() {
      const container = document.getElementById("assetItemsContainer");
      container.innerHTML = "";
      const stored = localStorage.getItem("assetPortfolio");
      let assets = [];
      if(stored) {
        assets = JSON.parse(stored);
      } else {
        // 기본 항목 (금액은 0)
        assets = [
          {name: "현금", amount: 0},
          {name: "채권", amount: 0},
          {name: "부동산", amount: 0},
          {name: "주식", amount: 0},
          {name: "기타", amount: 0}
        ];
        localStorage.setItem("assetPortfolio", JSON.stringify(assets));
      }
      assets.forEach(asset => container.appendChild(createAssetItem(asset)));
    }
    
    function saveAssetPortfolio() {
      const container = document.getElementById("assetItemsContainer");
      const assetItems = container.querySelectorAll(".asset-item");
      const assets = [];
      assetItems.forEach(item => {
        const inputs = item.querySelectorAll("input");
        const name = inputs[0].value.trim();
        const amount = Number(inputs[1].value.replace(/,/g, "")) || 0;
        assets.push({ name, amount });
      });
      localStorage.setItem("assetPortfolio", JSON.stringify(assets));
    }
    
    function updateAssetChart() {
      const container = document.getElementById("assetItemsContainer");
      const assetItems = container.querySelectorAll(".asset-item");
      const names = [];
      const amounts = [];
      assetItems.forEach(item => {
        const inputs = item.querySelectorAll("input");
        const name = inputs[0].value.trim() || "미입력";
        const amount = Number(inputs[1].value.replace(/,/g, "")) || 0;
        names.push(name);
        amounts.push(amount);
      });
      saveAssetPortfolio();
      
      const total = amounts.reduce((a,b) => a+b, 0);
      const ctx = document.getElementById("assetChart").getContext("2d");
      
      adjustChartSize("assetChart", names.length);
      
      // 라벨 폰트 크기를 동적으로 결정 (항목이 많으면 작게)
      let labelFontSize = names.length > 5 ? Math.max(10, 14 - (names.length - 5)) : 14;
      
      if(total === 0){
        ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px sans-serif";
        ctx.fillStyle = "#333";
        ctx.fillText("데이터가 없습니다.", 50, 150);
        updateAssetGoalProgress(); // 진행바도 초기화
        return;
      }
      
      const backgroundColors = names.map(() => {
        const r = Math.floor(Math.random() * 200);
        const g = Math.floor(Math.random() * 200);
        const b = Math.floor(Math.random() * 200);
        return `rgb(${r}, ${g}, ${b})`;
      });
      
      if(assetChart) {
        assetChart.data.labels = names;
        assetChart.data.datasets[0].data = amounts;
        assetChart.data.datasets[0].backgroundColor = backgroundColors;
        assetChart.options.plugins.datalabels.font.size = labelFontSize;
        assetChart.update();
      } else {
        assetChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: names,
            datasets: [{
              data: amounts,
              backgroundColor: backgroundColors,
              borderColor: "#fff",
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            layout: { padding: 20 },
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: '자산 포트폴리오' },
              datalabels: {
                display: true,
                color: '#fff',
                font: { size: 12, weight: 'bold' },
                formatter: (value, ctx) => {
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                  const label = ctx.chart.data.labels[ctx.dataIndex];
                  return label + ': ' + percentage + '%';
                }
              }
            }
          }
        });
      }
      
      updateAssetGoalProgress(); // 자산 변경 시 진행바 갱신
    }
    
    document.getElementById("addAssetItemBtn").addEventListener("click", () => {
      const container = document.getElementById("assetItemsContainer");
      container.appendChild(createAssetItem());
    });
    
    /* ---------- 주식 포트폴리오 기능 ---------- */
    function createStockItem(stock = {name:"", amount:0}) {
      const stockDiv = document.createElement("div");
      stockDiv.classList.add("stock-item");
      
      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "종목명 (예: AAPL)";
      nameInput.value = stock.name || "";
      nameInput.addEventListener("input", updateStockChart);
      
      const amountInput = document.createElement("input");
      // type 변경: number -> text
      amountInput.type = "text";
      amountInput.placeholder = "금액";
      amountInput.min = 0;
      amountInput.value = stock.amount || 0;
      amountInput.addEventListener("input", updateStockChart);
      addCommaFormatting(amountInput);
      
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "삭제";
      removeBtn.addEventListener("click", () => {
        stockDiv.remove();
        saveStockPortfolio();
        updateStockChart();
      });
      
      stockDiv.appendChild(nameInput);
      stockDiv.appendChild(amountInput);
      stockDiv.appendChild(removeBtn);
      return stockDiv;
    }
    
    function loadStockPortfolio() {
      const stockList = document.getElementById("stockList");
      stockList.innerHTML = "";
      const stored = localStorage.getItem("stockPortfolio");
      let stocks = [];
      if(stored) {
        stocks = JSON.parse(stored);
      } else {
        // 기본적으로 두 개의 항목 생성
        stocks = [{name:"", amount:0}, {name:"", amount:0}];
        localStorage.setItem("stockPortfolio", JSON.stringify(stocks));
      }
      stocks.forEach(stock => {
        stockList.appendChild(createStockItem({name: stock.name, amount: stock.amount}));
      });
    }
    
    function saveStockPortfolio() {
      const stockList = document.getElementById("stockList");
      const stockItems = stockList.querySelectorAll(".stock-item");
      const stocks = [];
      stockItems.forEach(item => {
        const inputs = item.querySelectorAll("input");
        const name = inputs[0].value.trim();
        const amount = Number(inputs[1].value.replace(/,/g, "")) || 0;
        stocks.push({ name, amount });
      });
      localStorage.setItem("stockPortfolio", JSON.stringify(stocks));
    }
    
    function updateStockChart() {
      const stockList = document.getElementById("stockList");
      const stockItems = stockList.querySelectorAll(".stock-item");
      const names = [];
      const amounts = [];
      stockItems.forEach(item => {
        const inputs = item.querySelectorAll("input");
        const stockName = inputs[0].value.trim() || "미입력";
        const stockAmount = Number(inputs[1].value.replace(/,/g, "")) || 0;
        names.push(stockName);
        amounts.push(stockAmount);
      });
      saveStockPortfolio();
      
      const total = amounts.reduce((a, b) => a + b, 0);
      const ctx = document.getElementById("stockChart").getContext("2d");
      
      adjustChartSize("stockChart", names.length);
      
      let labelFontSize = names.length > 5 ? Math.max(10, 14 - (names.length - 5)) : 14;
      
      if(total === 0) {
        ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);
        ctx.font = "16px sans-serif";
        ctx.fillStyle = "#333";
        ctx.fillText("데이터가 없습니다.", 50, 150);
        return;
      }
      
      const backgroundColors = names.map(() => {
        const r = Math.floor(Math.random() * 200);
        const g = Math.floor(Math.random() * 200);
        const b = Math.floor(Math.random() * 200);
        return `rgb(${r}, ${g}, ${b})`;
      });
      
      if(stockChart) {
        stockChart.data.labels = names;
        stockChart.data.datasets[0].data = amounts;
        stockChart.data.datasets[0].backgroundColor = backgroundColors;
        stockChart.options.plugins.datalabels.font.size = labelFontSize;
        stockChart.update();
      } else {
        stockChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: names,
            datasets: [{
              data: amounts,
              backgroundColor: backgroundColors,
              borderColor: "#fff",
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            layout: { padding: 20 },
            plugins: {
              legend: { position: 'bottom' },
              title: { display: true, text: '주식 포트폴리오' },
              datalabels: {
                display: true,
                color: '#fff',
                font: { size: 12, weight: 'bold' },
                formatter: (value, ctx) => {
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                  const label = ctx.chart.data.labels[ctx.dataIndex];
                  return label + ': ' + percentage + '%';
                }
              }
            }
          }
        });
      }
    }
    
    document.getElementById("addStockBtn").addEventListener("click", () => {
      const stockList = document.getElementById("stockList");
      stockList.appendChild(createStockItem());
    });
    
    /* ---------- 체크리스트 기능 ---------- */
    const CHECKLIST_KEY = "investmentChecklist";
    function loadChecklist() {
      const stored = localStorage.getItem(CHECKLIST_KEY);
      const checklistEl = document.getElementById("checklist");
      checklistEl.innerHTML = "";
      if (stored) {
        const items = JSON.parse(stored);
        items.forEach(item => {
          const li = document.createElement("li");
          li.innerHTML = `<span>${item.text}</span><input type="checkbox" class="check-input" ${item.checked ? "checked" : ""}>`;
          li.querySelector("input").addEventListener("change", saveChecklist);
          checklistEl.appendChild(li);
        });
      } else {
        // 기본 항목 추가
        const li = document.createElement("li");
        li.innerHTML = `<span>예시: PEG가 1 이하인 기업 (피터 린치)</span><input type="checkbox" class="check-input">`;
        li.querySelector("input").addEventListener("change", saveChecklist);
        checklistEl.appendChild(li);
        saveChecklist();
      }
    }
    function saveChecklist() {
      const checklistEl = document.getElementById("checklist");
      const items = [];
      checklistEl.querySelectorAll("li").forEach(li => {
        const text = li.querySelector("span").innerText;
        const checked = li.querySelector("input").checked;
        items.push({ text, checked });
      });
      localStorage.setItem(CHECKLIST_KEY, JSON.stringify(items));
    }
    document.getElementById("addChecklistItemBtn").addEventListener("click", function(){
      const input = document.getElementById("newChecklistItem");
      const text = input.value.trim();
      if(text !== ""){
        const li = document.createElement("li");
        li.innerHTML = `<span>${text}</span><input type="checkbox" class="check-input">`;
        li.querySelector("input").addEventListener("change", saveChecklist);
        document.getElementById("checklist").appendChild(li);
        input.value = "";
        saveChecklist();
      }
    });
    
    /* ---------- 자산 목표 기능 ---------- */
    function loadAssetGoal() {
      const savedGoal = localStorage.getItem("assetGoal");
      const display = document.getElementById("assetGoalDisplay");
      if (savedGoal) {
        // 숫자에 콤마 추가: toLocaleString() 사용
        display.textContent = "현재 목표: " + Number(savedGoal).toLocaleString() + " 원";
      } else {
        display.textContent = "자산 목표가 설정되지 않았습니다.";
      }
      updateAssetGoalProgress();
    }
    
    document.getElementById("saveAssetGoalBtn").addEventListener("click", () => {
      const input = document.getElementById("assetGoalInput");
      const goal = input.value.replace(/,/g, "").trim();
      if (goal === "" || isNaN(goal)) {
        alert("유효한 금액을 입력하세요.");
        return;
      }
      localStorage.setItem("assetGoal", goal);
      loadAssetGoal();
      alert("자산 목표가 저장되었습니다.");
    });
    
    // 자산 진행바 업데이트 함수: 현재 자산 합계와 목표 금액을 비교해 진행률을 표시합니다.
    function updateAssetGoalProgress() {
      const savedGoal = localStorage.getItem("assetGoal");
      const progressContainer = document.getElementById("assetGoalProgress");
      progressContainer.innerHTML = "";
      if (!savedGoal) {
        return;
      }
      const goal = Number(savedGoal);
      
      // 자산 포트폴리오 총합 계산 (저장된 자산 데이터를 사용)
      const storedAssets = localStorage.getItem("assetPortfolio");
      let totalAsset = 0;
      if (storedAssets) {
        const assets = JSON.parse(storedAssets);
        assets.forEach(asset => {
          totalAsset += Number(asset.amount) || 0;
        });
      }
      
      const percentage = Math.min(100, ((totalAsset / goal) * 100).toFixed(2));
      
      // 진행 상황 정보 표시
      const info = document.createElement("p");
      info.textContent = `현재 자산: ${totalAsset.toLocaleString()} 원 / 목표: ${goal.toLocaleString()} 원`;
      progressContainer.appendChild(info);
      
      // 진행바 요소 생성
      const progressBar = document.createElement("div");
      progressBar.classList.add("progress-bar");
      const progress = document.createElement("div");
      progress.classList.add("progress");
      progress.style.width = percentage + "%";
      progress.textContent = percentage + "%";
      progressBar.appendChild(progress);
      progressContainer.appendChild(progressBar);
    }
    
    /* ---------- 투자 일지 기능 ---------- */
    function loadDiaryEntries() {
      const diaryEntriesContainer = document.getElementById("diaryEntries");
      diaryEntriesContainer.innerHTML = "";
      const storedEntries = localStorage.getItem("investmentDiaryEntries");
      if (storedEntries) {
        const entries = JSON.parse(storedEntries);
        entries.forEach((entry, index) => {
          const div = document.createElement("div");
          div.className = "diary-entry";
          div.setAttribute("data-index", index);
          const timeElem = document.createElement("time");
          timeElem.textContent = entry.date;
          div.appendChild(timeElem);
          const textElem = document.createElement("span");
          textElem.className = "diary-text";
          textElem.textContent = entry.text;
          div.appendChild(textElem);
          
          // 수정 버튼
          const editBtn = document.createElement("button");
          editBtn.textContent = "수정";
          editBtn.style.marginLeft = "8px";
          editBtn.addEventListener("click", () => {
            const newText = prompt("수정할 내용을 입력하세요", entry.text);
            if(newText !== null && newText.trim() !== ""){
              entry.text = newText.trim();
              updateDiaryEntries(entries);
            }
          });
          div.appendChild(editBtn);
          
          // 삭제 버튼
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "삭제";
          deleteBtn.style.marginLeft = "4px";
          deleteBtn.addEventListener("click", () => {
            if(confirm("정말 삭제하시겠습니까?")){
              entries.splice(index, 1);
              updateDiaryEntries(entries);
            }
          });
          div.appendChild(deleteBtn);
          
          diaryEntriesContainer.appendChild(div);
        });
      }
    }
    function updateDiaryEntries(entries) {
      localStorage.setItem("investmentDiaryEntries", JSON.stringify(entries));
      loadDiaryEntries();
    }
    document.getElementById("saveDiaryBtn").addEventListener("click", () => {
      const diaryTextarea = document.getElementById("investmentDiary");
      const diaryText = diaryTextarea.value.trim();
      if(diaryText === ""){
        alert("투자 일지를 작성해주세요.");
        return;
      }
      const now = new Date();
      const entry = {
        date: now.toLocaleString(),
        text: diaryText
      };
      let entries = [];
      const storedEntries = localStorage.getItem("investmentDiaryEntries");
      if(storedEntries){
        entries = JSON.parse(storedEntries);
      }
      entries.push(entry);
      localStorage.setItem("investmentDiaryEntries", JSON.stringify(entries));
      diaryTextarea.value = "";
      loadDiaryEntries();
      alert("투자 일지가 저장되었습니다.");
    });
    
    /* ---------- 데이터 초기화 기능 ---------- */
    document.getElementById("resetDataBtn").addEventListener("click", () => {
      if(confirm("모든 데이터를 초기화 하시겠습니까?")) {
        localStorage.removeItem("assetPortfolio");
        localStorage.removeItem("stockPortfolio");
        localStorage.removeItem(CHECKLIST_KEY);
        localStorage.removeItem("assetGoal");
        localStorage.removeItem("investmentDiaryEntries");
        location.reload();
      }
    });
    
    /* ---------- 초기 로드 ---------- */
    document.addEventListener("DOMContentLoaded", () => {
      loadAssetPortfolio();
      loadStockPortfolio();
      loadChecklist();
      loadAssetGoal();
      loadDiaryEntries();
      
      updateAssetChart();
      updateStockChart();
      
      // 자산 목표 입력 필드에도 실시간 쉼표 포맷팅 적용
      addCommaFormatting(document.getElementById("assetGoalInput"));
      
      // 별도 업데이트 버튼이 있다면 이벤트 연결 (현재는 자동 업데이트)
      // document.getElementById("updateAssetChart").addEventListener("click", updateAssetChart);
    });
  </script>
</body>
</html>
